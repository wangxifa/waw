(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{501:function(e,s,n){"use strict";n.r(s);var a=n(4),r=Object(a.a)({},(function(){var e=this,s=e.$createElement,n=e._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h3",{attrs:{id:"webpack的定义"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#webpack的定义"}},[e._v("#")]),e._v(" Webpack的定义")]),e._v(" "),n("ol",[n("li",[e._v("利用babel完成代码转换,并生成单个文件的依赖")]),e._v(" "),n("li",[e._v("生成依赖图谱")]),e._v(" "),n("li",[e._v("生成最后打包代码")])]),e._v(" "),n("h3",{attrs:{id:"第一步-转换代码、-生成依赖"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第一步-转换代码、-生成依赖"}},[e._v("#")]),e._v(" 第一步:转换代码、 生成依赖")]),e._v(" "),n("p",[e._v("转换代码需要利用@babel/parser生成AST抽象语法树，然后利用@babel/traverse进行AST遍历，记录依赖关系，最后通过@babel/core和@babel/preset-env进行代码的转换")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("//先安装好相应的包\nnpm install @babel/parser @babel/traverse @babel/core @babel/preset-env -D\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("//导入包\nconst fs = require('fs')\nconst path = require('path')\nconst parser = require('@babel/parser')\nconst traverse = require('@babel/traverse').default\nconst babel = require('@babel/core')\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("function stepOne(filename){\n    //读入文件\n    const content =  fs.readFileSync(filename, 'utf-8')\n    const ast = parser.parse(content, {\n        sourceType: 'module'//babel官方规定必须加这个参数，不然无法识别ES Module\n    })\n    const dependencies = {}\n    //遍历AST抽象语法树\n    traverse(ast, {\n        //获取通过import引入的模块\n        ImportDeclaration({node}){\n            const dirname = path.dirname(filename)\n            const newFile = './' + path.join(dirname, node.source.value)\n            //保存所依赖的模块\n            dependencies[node.source.value] = newFile\n        }\n    })\n    //通过@babel/core和@babel/preset-env进行代码的转换\n    const {code} = babel.transformFromAst(ast, null, {\n        presets: [\"@babel/preset-env\"]\n    })\n    return{\n        filename,//该文件名\n        dependencies,//该文件所依赖的模块集合(键值对存储)\n        code//转换后的代码\n    }\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br")])]),n("h3",{attrs:{id:"第二步-生成依赖图谱。"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第二步-生成依赖图谱。"}},[e._v("#")]),e._v(" 第二步：生成依赖图谱。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("//entry为入口文件\nfunction stepTwo(entry){\n    const entryModule = stepOne(entry)\n    \n    //这个数组是核心，虽然现在只有一个元素，往后看你就会明白\n    const graphArray = [entryModule]\n    \n    for(let i = 0; i < graphArray.length; i++){\n        const item = graphArray[i];\n        const {dependencies} = item;//拿到文件所依赖的模块集合(键值对存储)\n        for(let j in dependencies){\n            graphArray.push(\n                stepOne(dependencies[j])\n            )//敲黑板！关键代码，目的是将入口模块及其所有相关的模块放入数组\n        }\n    }\n    \n    //接下来生成图谱\n    const graph = {}\n    graphArray.forEach(item => {\n        graph[item.filename] = {\n            dependencies: item.dependencies,\n            code: item.code\n        }\n    })\n    return graph\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br")])]),n("h3",{attrs:{id:"第三步-生成代码字符串"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第三步-生成代码字符串"}},[e._v("#")]),e._v(" 第三步: 生成代码字符串")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("//下面是生成代码字符串的操作，仔细看，不要眨眼睛哦！\nfunction step3(entry){\n    //要先把对象转换为字符串，不然在下面的模板字符串中会默认调取对象的toString方法，参数变成[Object object],显然不行\n    const graph = JSON.stringify(stepTwo(entry))\n    console.log(graph, stepTwo(entry));\n    \n    return `\n        (function(graph) {\n            //require函数的本质是执行一个模块的代码，然后将相应变量挂载到exports对象上\n            function require(module) {\n                //localRequire的本质是拿到依赖包的exports变量\n                function localRequire(relativePath) {\n                    return require(graph[module].dependencies[relativePath]);\n                }\n                var exports = {};\n                (function(require, exports, code) {\n                    eval(code);\n                })(localRequire, exports, graph[module].code);\n                return exports;//函数返回指向局部变量，形成闭包，exports变量在函数执行后不会被摧毁\n            }\n            require('${entry}')\n        })(${graph})`\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br")])]),n("h3",{attrs:{id:"测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[e._v("#")]),e._v(" 测试")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("const code = step3('./index.js')\nconsole.log(code)\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br")])]),n("p",[e._v("将结果放在浏览器打印")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('(function(graph) {\n            //require函数的本质是执行一个模块的代码，然后将相应变量挂载到exports对象上\n            function require(module) {\n                //localRequire的本质是拿到依赖包的exports变量\n                function localRequire(relativePath) {\n                    return require(graph[module].dependencies[relativePath]);\n                }\n                var exports = {};\n                (function(require, exports, code) {\n                    eval(code);\n                })(localRequire, exports, graph[module].code);\n                return exports;//函数返回指向局部变量，形成闭包，exports变量在函数执行后不会被摧毁\n            }\n            require(\'./index.js\')\n        })({"./index.js":{"dependencies":{"./message.js":"./message.js"},"code":"\\"use strict\\";\\n\\nvar _message = _interopRequireDefault(require(\\"./message.js\\"));\\n\\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { \\"default\\": obj }; }\\n\\nconsole.log(_message[\\"default\\"]);"},"./message.js":{"dependencies":{"./word.js":"./word.js"},"code":"\\"use strict\\";\\n\\nObject.defineProperty(exports, \\"__esModule\\", {\\n  value: true\\n});\\nexports[\\"default\\"] = void 0;\\n\\nvar _word = require(\\"./word.js\\");\\n\\n//message.js\\nvar message = \\"say \\".concat(_word.word);\\nvar _default = message;\\nexports[\\"default\\"] = _default;"},"./word.js":{"dependencies":{},"code":"\\"use strict\\";\\n\\nObject.defineProperty(exports, \\"__esModule\\", {\\n  value: true\\n});\\nexports.word = void 0;\\n//word.js\\nvar word = \'hello\';\\nexports.word = word;"}})\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br")])])])}),[],!1,null,null,null);s.default=r.exports}}]);